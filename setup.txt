Prerequisites Setup

1. MongoDB Cluster (Already Documented)

Follow your existing MongoDB setup in _wdk_docker_network/:

# Add hostnames to /etc/hosts
echo "127.0.0.1 mongo1 mongo2 mongo3" | sudo tee -a /etc/hosts

# Start replica set
cd _mongo_db_local/
npm install
npm run start:db
npm run init:rs

Connection string: mongodb://mongo1:27017,mongo2:27017,mongo3:27017/?replicaSet=rs0

2. Create MongoDB Databases

Connect to MongoDB and create necessary databases:

mongosh mongodb://mongo1:27017,mongo2:27017,mongo3:27017/?replicaSet=rs0

# In mongosh:
use wdk_data_shard
use wdk_indexer_evm

Minimal Indexer Setup (6 Processes)

Step 1: Configure Shared Secrets

CRITICAL: All services must share the same capability and crypto.key for P2P communication via Hyperswarm.

Create a shared secrets file to use across all configs:
- topicConf.capability: A shared handshake secret
- topicConf.crypto.key: A shared encryption key

Step 2: EVM Indexer (Ethereum)

cd wdk-indexer-wrk-evm/
npm install
./setup-config.sh

# Edit config files:
# - config/common.json: Set debug level, dbEngine=hyperdb, topicConf (capability & crypto.key)
# - config/facs/db-mongo.config.json: Set MongoDB connection URI
# - config/eth.json: Set RPC URL (Infura/Alchemy), chain settings

# Start Proc worker (writer)
node worker.js --wtype wrk-evm-indexer-proc --env development --rack eth-proc --chain eth
# ⚠️ NOTE THE PROC RPC KEY from logs!

Step 3: EVM Indexer API

# In a new terminal, same directory
cd wdk-indexer-wrk-evm/
node worker.js --wtype wrk-evm-indexer-api --env development --rack eth-api --chain eth --proc-rpc <ETH_PROC_RPC_KEY>

Step 4: Data Shard Proc Worker

cd wdk-data-shard-wrk/
npm install
./setup-config.sh

# Edit config files:
# - config/common.json: Set shardTopic, blockchains, topicConf (SAME as indexer!)
# - config/facs/db-mongo.config.json: Set MongoDB URI

# Start Proc worker
node worker.js --wtype wrk-data-shard-proc --env development --rack shard-proc
# ⚠️ NOTE THE PROC RPC KEY from logs!

Step 5: Data Shard API Worker

# In a new terminal
cd wdk-data-shard-wrk/
node worker.js --wtype wrk-data-shard-api --env development --rack shard-api --proc-rpc <SHARD_PROC_RPC_KEY>

Step 6: Org Service (API Gateway)

cd wdk-ork-wrk/
npm install
./setup-config.sh

# Edit config/common.json: Set orkTopic, shardTopic, topicConf (SAME as others!)

# Start Org API worker
node worker.js --wtype wrk-ork-api --env development --rack ork-api

Step 7 (Optional): HTTP App Node

cd wdk-indexer-app-node/
npm install
./setup-config.sh

# Edit config/common.json: Set topicConf (SAME as others!)

# Start HTTP server
node worker.js --wtype wdk-server-http-base --env development --port 3000
# Access at http://localhost:3000

Boot Order Summary

1. MongoDB (via Docker) ✓
2. EVM Indexer Proc → get RPC key
3. EVM Indexer API → use proc RPC key
4. Data Shard Proc → get RPC key
5. Data Shard API → use proc RPC key
6. Org Service API → discovers data shards
7. App Node HTTP (optional) → port 3000

Key Configuration Notes

- RPC Endpoints: You'll need an Ethereum RPC endpoint (Infura/Alchemy API key) in config/eth.json
- Hyperswarm Topics: All services discover each other via topics and shared capability/crypto keys
- MongoDB URI Format:
mongodb://mongo1:27017,mongo2:27017,mongo3:27017/wdk_data_shard?replicaSet=rs0

Health Checks

# MongoDB
mongosh mongodb://mongo1:27017,mongo2:27017,mongo3:27017/?replicaSet=rs0 --eval "db.adminCommand('ping')"

# Check service logs for:
# - "Worker started successfully"
# - "Connected to MongoDB"
# - "Hyperswarm topic joined: <topic>"
# - "RPC server listening"

# Test HTTP endpoint (if running app node)
curl http://localhost:3000/health